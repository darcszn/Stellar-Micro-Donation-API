name: Label-Based CI Enforcement

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]
    branches: [ main, develop ]

jobs:
  check-labels:
    name: Detect PR Labels
    runs-on: ubuntu-latest
    outputs:
      is-testing: ${{ steps.labels.outputs.is-testing }}
      is-security: ${{ steps.labels.outputs.is-security }}
    steps:
      - name: Check labels
        id: labels
        run: |
          echo "is-testing=${{ contains(github.event.pull_request.labels.*.name, 'testing') }}" >> $GITHUB_OUTPUT
          echo "is-security=${{ contains(github.event.pull_request.labels.*.name, 'security') }}" >> $GITHUB_OUTPUT

  extended-testing:
    name: Extended Test Suite
    needs: check-labels
    if: needs.check-labels.outputs.is-testing == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run full test suite
        run: npm test
        env:
          CI: true
          MOCK_STELLAR: true
          API_KEYS: test-key-1,test-key-2
      
      - name: Enforce strict coverage
        run: npm run test:coverage
        env:
          CI: true
          MOCK_STELLAR: true
          API_KEYS: test-key-1,test-key-2
      
      - name: Validate coverage thresholds
        run: |
          if ! grep -q "All files" coverage/coverage-summary.json; then
            echo "‚ùå Coverage report not generated"
            exit 1
          fi
          echo "‚úÖ Extended testing passed with coverage validation"

  extended-security:
    name: Extended Security Checks
    needs: check-labels
    if: needs.check-labels.outputs.is-security == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Strict dependency audit
        run: npm audit --audit-level=moderate
      
      - name: Security linting (zero warnings)
        run: npm run lint:security -- --max-warnings=0
      
      - name: Check for hardcoded secrets
        run: |
          if grep -r -E "(password|secret|api[_-]?key|token)\s*=\s*['\"][^'\"]+['\"]" src/ --exclude-dir=node_modules; then
            echo "‚ùå Potential hardcoded secrets detected"
            exit 1
          fi
          echo "‚úÖ No hardcoded secrets found"
      
      - name: Validate environment variable usage
        run: |
          if grep -r "process\.env\." src/ | grep -v "process\.env\.NODE_ENV" | grep -v "process\.env\.PORT" | grep -v "process\.env\.STELLAR_NETWORK" | grep -v "process\.env\.HORIZON_URL" | grep -v "process\.env\.MOCK_STELLAR" | grep -v "process\.env\.API_KEYS" | grep -v "process\.env\.ENCRYPTION_KEY"; then
            echo "‚ö†Ô∏è  Review environment variable usage"
          fi
          echo "‚úÖ Extended security checks passed"

  enforcement-status:
    name: Label Enforcement Status
    runs-on: ubuntu-latest
    needs: [check-labels, extended-testing, extended-security]
    if: always()
    steps:
      - name: Report status
        run: |
          echo "üè∑Ô∏è  Label Detection:"
          echo "  Testing: ${{ needs.check-labels.outputs.is-testing }}"
          echo "  Security: ${{ needs.check-labels.outputs.is-security }}"
          echo ""
          
          if [ "${{ needs.check-labels.outputs.is-testing }}" == "true" ]; then
            echo "üß™ Extended Testing: ${{ needs.extended-testing.result }}"
            if [ "${{ needs.extended-testing.result }}" != "success" ]; then
              echo "‚ùå Extended testing checks failed"
              exit 1
            fi
          fi
          
          if [ "${{ needs.check-labels.outputs.is-security }}" == "true" ]; then
            echo "üîí Extended Security: ${{ needs.extended-security.result }}"
            if [ "${{ needs.extended-security.result }}" != "success" ]; then
              echo "‚ùå Extended security checks failed"
              exit 1
            fi
          fi
          
          echo "‚úÖ All label-based enforcement checks passed!"
